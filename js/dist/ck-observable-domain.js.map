{"version":3,"sources":["webpack://ckObservableDomain/webpack/universalModuleDefinition","webpack://ckObservableDomain/webpack/bootstrap","webpack://ckObservableDomain/./src/index.ts","webpack://ckObservableDomain/./node_modules/@signature/json-graph-serializer/src/index.js"],"names":["root","factory","exports","module","define","amd","this","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","json_graph_serializer_1","ObservableDomain","initialState","_this","deserialize","prefix","props","P","tranNum","N","graph","g","len","length","v","undefined","liftGraphContainerContent","O","roots","R","map","applyEvent","event","Error","events","E","e","newOne","Map","Set","push","getValue","a","idx","splice","Array","clear","delete","ref","serialize","options","substitor","assign","rR","rI","rT","marker","cleanup","markObj","JSON","stringify","k","[object Object]","Number","markNum","sv","String","markTyp","forEach","activator","extRef","rev","type","add","parse","processA","has","set","__webpack_exports__"],"mappings":"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","file":"ck-observable-domain.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"ckObservableDomain\"] = factory();\n\telse\n\t\troot[\"ckObservableDomain\"] = factory();\n})(this, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","/* tslint:disable */\r\nimport { deserialize } from \"@signature/json-graph-serializer\";\r\n\r\nexport interface ObservableDomainEvent {\r\n    N: number;\r\n    E: [string, string, number | string][]; // EventCode, TargetRef, Param\r\n}\r\n\r\nexport interface ObservableDomainState {\r\n    N: number;\r\n    P: string[];\r\n    O: any;\r\n    R: string[];\r\n}\r\n\r\nfunction liftGraphContainerContent(g: any[]) {\r\n    const len = g.length;\r\n    for (let i = 0; i < len; ++i) {\r\n        const o = g[i];\r\n        if (o && typeof (o) === \"object\") {\r\n            for (let p in o) {\r\n                const v = o[p];\r\n                if (v && typeof (v) === \"object\") {\r\n                    const c = v[\"$C\"];\r\n                    if (c !== undefined) {\r\n                        o[p] = g[v[\"$i\"]];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return g;\r\n}\r\n\r\nexport class ObservableDomain {\r\n    private o: ObservableDomainState;\r\n    private props: string[];\r\n    private tranNum: number;\r\n    public graph: any;\r\n    public roots: any[];\r\n\r\n    constructor(initialState: string | ObservableDomainState) {\r\n        this.o = typeof (initialState) === \"string\"\r\n            ? deserialize(initialState, { prefix: \"\" })\r\n            : initialState;\r\n        this.props = this.o.P;\r\n        this.tranNum = this.o.N\r\n        this.graph = liftGraphContainerContent(this.o.O);\r\n\r\n        this.roots = this.o.R.map(i => this.graph[i]);\r\n    }\r\n\r\n    public applyEvent(event: ObservableDomainEvent) {\r\n        if (this.tranNum + 1 > event.N) {\r\n            throw new Error(`Invalid transaction number. Expected: greater than ${this.tranNum + 1}, got ${event.N}.`);\r\n        }\r\n\r\n        const events = event.E;\r\n        for (let i = 0; i < events.length; ++i) {\r\n            const e = events[i];\r\n            const code: string = e[0];\r\n            switch (code) {\r\n                case \"N\":  // NewObject\r\n                    {\r\n                        let newOne;\r\n                        switch (e[2]) {\r\n                            case \"\": newOne = {}; break;\r\n                            case \"A\": newOne = []; break;\r\n                            case \"M\": newOne = new Map(); break;\r\n                            case \"S\": newOne = new Set(); break;\r\n                            default: throw new Error(`Unexpected Object type; ${e[2]}. Must be A, M, S or empty string.`);\r\n                        }\r\n                        this.graph[e[1]] = newOne;\r\n                        break;\r\n                    }\r\n                case \"D\":  // DisposedObject\r\n                    {\r\n                        this.graph[e[1]] = null;\r\n                        break;\r\n                    }\r\n                case \"P\":  // NewProperty\r\n                    {\r\n                        if (e[2] != this.props.length) {\r\n                            throw new Error(`Invalid property creation event for '${e[1]}': index must be ${this.props.length}, got ${e[2]}.`);\r\n                        }\r\n                        this.props.push(e[1]);\r\n                        break;\r\n                    }\r\n                case \"C\":  // PropertyChanged\r\n                    {\r\n                        this.graph[e[1]][this.props[<any>e[2]]] = this.getValue(e[3]);\r\n                        break;\r\n                    }\r\n                case \"I\":  // ListInsert\r\n                    {\r\n                        const a = this.graph[e[1]];\r\n                        const idx = e[2];\r\n                        const v = this.getValue(e[3]);\r\n                        if (idx === a.length) a[idx] = v;\r\n                        else a.splice(idx, 0, v);\r\n                        break;\r\n                    }\r\n                case \"CL\": // CollectionClear\r\n                    {\r\n                        const c = this.graph[e[1]];\r\n                        if (c instanceof Array) c.length = 0;\r\n                        else c.clear();\r\n                        break;\r\n                    }\r\n                case \"R\":  // ListRemoveAt\r\n                    {\r\n                        this.graph[e[1]].splice(e[2], 1);\r\n                        break;\r\n                    }\r\n                case \"S\":  // ListSetAt\r\n                    {\r\n                        this.graph[e[1]].splice(e[2], 1, this.getValue(e[3]));\r\n                        break;\r\n                    }\r\n                case \"K\":   // CollectionRemoveKey\r\n                    {\r\n                        this.graph[e[1]].delete(this.getValue(e[2]));\r\n                        break;\r\n                    }\r\n                default: throw new Error(`Unexpected Event code: '${e[0]}'.`);\r\n            }\r\n        }\r\n        this.tranNum = event.N;\r\n    }\r\n\r\n    private getValue(o: any) {\r\n        if (o != null) {\r\n            var ref = o[\">\"];\r\n            if (ref !== undefined) return this.graph[ref];\r\n        }\r\n        return o;\r\n    }\r\n}","/**\r\n * Serializes an object in JSON that can contain internal relationships.\r\n * Serialized objects contain a \"<prefix>i\" field that is the index\r\n * in the breadth-first traversal of the graph done by JSON.stringify().\r\n * References to already serialized objects are exposed as single-property\r\n * objects like { \"<prefix>r\": idx }.\r\n * The deserialize function uses the index to restore the complete graph.\r\n * Parameter prefix is optional. It defaults to \"~$£€\".\r\n * @param {object} o - The object to serialize\r\n * @param {object} options - Serialization options: prefix (default '~$£€'), substitor\r\n * @return {string} The serialized value.\r\n */\r\nexport function serialize(o, options) {\r\n    const { prefix, substitor } = Object.assign({ prefix: \"~$£€\" }, options);\r\n    const rR = prefix + \">\";\r\n    const rI = prefix + \"°\";\r\n    const rT = prefix + \"þ\";\r\n    const marker = Symbol();\r\n    let cleanup = [];\r\n    try {\r\n        let c = 0;\r\n        function markObj(o) { o[marker] = 1; return o; }\r\n        function markNum(n) { return markObj(new Number(n)); }\r\n        function markTyp(s) {\r\n            if (typeof s !== \"string\") throw new Error(\"Type must be a String.\");\r\n            return markObj(new String(s));\r\n        }\r\n        return JSON.stringify(o, function (k, v) {\r\n            if (k === rR || k === rI || k === rT) {\r\n                if (v !== null && v[marker]) return v;\r\n                throw new Error(\"Conflicting serialization prefix: property '\" + k + \"' exists.\");\r\n            }\r\n            if (v === null || typeof v !== \"object\" || v[marker]) return v;\r\n            let ref = v[rI];\r\n            if (ref) {\r\n                if (ref[marker]) return { [rR]: ref };\r\n                throw new Error(\"Conflicting serialization prefix: property '\" + rI + \"' exists.\");\r\n            }\r\n            v[rI] = ref = markNum(c++);\r\n            cleanup.push(v);\r\n            if (v instanceof Array) {\r\n                v = markObj([markObj({ [rT]: markObj([ref, \"A\"]) }), ...v]);\r\n            }\r\n            else if (v instanceof Map) {\r\n                v = markObj([markObj({ [rT]: markObj([ref, \"M\"]) }), ...[...v].map(e => markObj(e))]);\r\n            }\r\n            else if (v instanceof Set) {\r\n                v = markObj([markObj({ [rT]: markObj([ref, \"S\"]) }), ...v]);\r\n            }\r\n            else if (substitor) {\r\n                let sv = substitor(v, rT);\r\n                if (sv && sv !== v) {\r\n                    v = sv;\r\n                    v[rI] = ref;\r\n                    v[rT] = markTyp(v[rT] || \"\");\r\n                }\r\n            }\r\n            return v;\r\n        });\r\n    }\r\n    finally {\r\n        cleanup.forEach(o => delete o[rI]);\r\n    }\r\n};\r\n\r\n/**\r\n * Deserializes a previously-serialized object graph.\r\n * Parameter prefix is optional and defaults to \"~$£€\": it must, of course,\r\n * be the same as the prefix used to serialize the graph.\r\n * @param {(string|object)} o - The serialized string, or parsed object.\r\n * @param {object} options - Serialization options: prefix (default '~$£€'), activator\r\n * @return {object} The deserialized value.\r\n */\r\nexport function deserialize(s /*:string|object*/, options) {\r\n    const { prefix, activator } = Object.assign({ prefix: \"~$£€\" }, options);\r\n    const rR = prefix + \">\";\r\n    const rI = prefix + \"°\";\r\n    const rT = prefix + \"þ\";\r\n    let extRef = null;\r\n    const map = [];\r\n\r\n    function rev(k, v) {\r\n        let type = null;\r\n        if (v instanceof Array) {\r\n            if (v.length > 0\r\n                && v[0] != null\r\n                && (type = v[0][rT]) !== undefined) {\r\n                v.splice(0, 1);\r\n                switch (type[1]) {\r\n                    case \"A\": break;\r\n                    case \"M\": v = Object.assign(new Map(), { \"v\": v }); break;\r\n                    case \"S\": v = Object.assign(new Set(), { \"v\": v }); break;\r\n                    default: throw new Error(\"Expecting typed array to be 'A', 'M' or 'S'.\");\r\n                }\r\n                map[type[0]] = v;\r\n            }\r\n        }\r\n        else if (v !== null) {\r\n            const idx = v[rI];\r\n            if (idx !== undefined) {\r\n                delete v[rI];\r\n                if ((type = v[rT]) !== undefined) {\r\n                    delete v[rT];\r\n                    if (activator) {\r\n                        v = activator(v, type);\r\n                        if (v) {\r\n                            if (extRef === null) extRef = new Set();\r\n                            extRef.add(v);\r\n                        }\r\n                    }\r\n                }\r\n                map[idx] = v;\r\n            }\r\n        }\r\n        return v;\r\n    }\r\n\r\n    // This simple depth-first traversal applies the reviver to an already \r\n    // JSON parsed tree.\r\n    function d(o) {\r\n        if (o) {\r\n            if (o instanceof Array) {\r\n                for (let i = 0; i < o.length; ++i) {\r\n                    const v = o[i];\r\n                    d(v);\r\n                    o[i] = rev(i, v);\r\n                }\r\n            }\r\n            else if (typeof (o) === \"object\") {\r\n                for (const p in o) {\r\n                    const v = o[p];\r\n                    d(v);\r\n                    o[p] = rev(p, v);\r\n                }\r\n            }\r\n        }\r\n        return o;\r\n    }\r\n    // If its a string, JSON.parse and the reviver handle the first step: registering the \r\n    // objects in map array and any external references into extRef set.   \r\n    const o = typeof (s) === \"string\"\r\n        ? JSON.parse(s, rev)\r\n        : rev(undefined, d(s));\r\n\r\n    // Second step is to handles the collections (array, map and set).\r\n    function processA(map, a) {\r\n        const len = a.length;\r\n        for (let i = 0; i < len; ++i) {\r\n            const c = a[i];\r\n            if (c) {\r\n                const ref = c[rR];\r\n                if (ref !== undefined) a[i] = map[ref];\r\n            }\r\n        }\r\n    }\r\n    for (let i of map) {\r\n        if (extRef === null || !extRef.has(i)) {\r\n            if (i instanceof Array) {\r\n                processA(map, i);\r\n            }\r\n            else if (i instanceof Map) {\r\n                i.v.forEach(e => processA(map, e));\r\n                i.v.forEach(e => i.set(e[0], e[1]));\r\n                delete i.v;\r\n            }\r\n            else if (i instanceof Set) {\r\n                processA(map, i.v);\r\n                i.v.forEach(e => i.add(e));\r\n                delete i.v;\r\n            }\r\n            else {\r\n                for (const p in i) {\r\n                    const o = i[p];\r\n                    if (o !== null) {\r\n                        const ref = o[rR];\r\n                        if (ref !== undefined) i[p] = map[ref];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return o;\r\n}"],"sourceRoot":""}