{"version":3,"sources":["webpack://ckObservableDomain/webpack/universalModuleDefinition","webpack://ckObservableDomain/webpack/bootstrap","webpack://ckObservableDomain/./src/index.ts","webpack://ckObservableDomain/./node_modules/@signature/json-graph-serializer/src/index.js"],"names":["root","factory","exports","module","define","amd","this","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","json_graph_serializer_1","ObservableDomain","initialState","_this","deserialize","prefix","_props","P","_tranNum","N","_objCount","C","_graph","O","_roots","R","map","g","g_1","_i","length","_a","sent","all","applyEvent","event","Error","events","E","e","newOne","Map","Set","push","getValue","a","idx","v","splice","Array","clear","delete","ref","undefined","serialize","options","substitor","assign","rR","rI","rT","marker","cleanup","markObj","JSON","stringify","k","[object Object]","Number","markNum","sv","String","markTyp","forEach","activator","extRef","rev","type","add","parse","processA","len","has","set","__webpack_exports__"],"mappings":"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","file":"ck-observable-domain.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"ckObservableDomain\"] = factory();\n\telse\n\t\troot[\"ckObservableDomain\"] = factory();\n})(this, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","/* tslint:disable */\r\nimport { deserialize } from \"@signature/json-graph-serializer\";\r\n\r\nexport interface ObservableDomainEvent {\r\n    N: number;\r\n    E: any[];\r\n}\r\n\r\nexport interface ObservableDomainState {\r\n    N: number;\r\n    C: number;\r\n    P: string[];\r\n    O: any;\r\n    R: number[];\r\n}\r\n\r\nexport class ObservableDomain {\r\n    private readonly _props: string[];\r\n    private _tranNum: number;\r\n    private _objCount: number;\r\n    private readonly _graph: any[];\r\n    private readonly  _roots: any[];        \r\n\r\n    constructor(initialState: string | ObservableDomainState) {\r\n        const o : ObservableDomainState = typeof (initialState) === \"string\"\r\n                                            ? deserialize(initialState, { prefix: \"\" })\r\n                                            : initialState;\r\n        this._props = o.P;\r\n        this._tranNum = o.N;\r\n        this._objCount = o.C;\r\n        //const r = countAndLiftContainers(o.O);\r\n        this._graph = o.O;\r\n        this._roots = o.R.map(i => this._graph[i]);\r\n\r\n        // function countAndLiftContainers(g: any[]) {\r\n        //     let count = 0;\r\n        //     const len = g.length;\r\n        //     for (let i = 0; i < len; ++i) {\r\n        //         const o = g[i];\r\n        //         if (o != null ) {\r\n        //             ++count;\r\n        //             if( typeof o === \"object\") {\r\n        //                 for (let p in o) {\r\n        //                     const v = o[p];\r\n        //                     if (v && typeof v === \"object\") {\r\n        //                         const c = v[\"$C\"];\r\n        //                         if (c !== undefined) {\r\n        //                             o[p] = g[v[\"$i\"]];\r\n        //                         }\r\n        //                     }\r\n        //                 }\r\n        //             }   \r\n        //         }\r\n        //     }\r\n        //     return {count:count,graph:g};\r\n        // }\r\n    }\r\n\r\n    public get transactionNumber() : number { \r\n        return this._tranNum;\r\n    }\r\n\r\n    public get allObjectsCount() : number { \r\n        return this._objCount;\r\n    }\r\n\r\n    public get allObjects() : Iterable<any>  { \r\n        function* all(g:any[])\r\n        {\r\n            for( const o of g )\r\n            {\r\n                if( o !== null ) yield o;\r\n            }\r\n        }\r\n        return all( this._graph );\r\n     }\r\n\r\n    public get roots() : ReadonlyArray<any> { \r\n        return this._roots;\r\n    }\r\n\r\n    public applyEvent(event: ObservableDomainEvent) {\r\n        if (this._tranNum + 1 !== event.N) {\r\n            throw new Error(`Invalid transaction number. Expected: ${this._tranNum + 1}, got ${event.N}.`);\r\n        }\r\n\r\n        const events = event.E;\r\n        for (let i = 0; i < events.length; ++i) {\r\n            const e = events[i];\r\n            const code: string = e[0];\r\n            switch (code) {\r\n                case \"N\": // NewObject\r\n                    {\r\n                        let newOne;\r\n                        switch (e[2]) {\r\n                            case \"\": newOne = {}; break;\r\n                            case \"A\": newOne = []; break;\r\n                            case \"M\": newOne = new Map(); break;\r\n                            case \"S\": newOne = new Set(); break;\r\n                            default: throw new Error(`Unexpected Object type; ${e[2]}. Must be A, M, S or empty string.`);\r\n                        }\r\n                        this._graph[e[1]] = newOne;\r\n                        this._objCount++;\r\n                        break;\r\n                    }\r\n                case \"D\": // DisposedObject\r\n                    {\r\n                        this._graph[e[1]] = null;\r\n                        this._objCount--;\r\n                        break;\r\n                    }\r\n                case \"P\": // NewProperty\r\n                    {\r\n                        if (e[2] != this._props.length) {\r\n                            throw new Error(`Invalid property creation event for '${e[1]}': index must be ${this._props.length}, got ${e[2]}.`);\r\n                        }\r\n                        this._props.push(e[1]);\r\n                        break;\r\n                    }\r\n                case \"C\":  // PropertyChanged\r\n                    {\r\n                        this._graph[e[1]][this._props[<any>e[2]]] = this.getValue(e[3]);\r\n                        break;\r\n                    }\r\n                case \"I\":  // ListInsert\r\n                    {\r\n                        const a = this._graph[e[1]];\r\n                        const idx = e[2];\r\n                        const v = this.getValue(e[3]);\r\n                        if (idx === a.length) a[idx] = v;\r\n                        else a.splice(idx, 0, v);\r\n                        break;\r\n                    }\r\n                case \"CL\": // CollectionClear\r\n                    {\r\n                        const c = this._graph[e[1]];\r\n                        if (c instanceof Array) c.length = 0;\r\n                        else c.clear();\r\n                        break;\r\n                    }\r\n                case \"R\":  // ListRemoveAt\r\n                    {\r\n                        this._graph[e[1]].splice(e[2], 1);\r\n                        break;\r\n                    }\r\n                case \"S\":  // ListSetAt\r\n                    {\r\n                        this._graph[e[1]].splice(e[2], 1, this.getValue(e[3]));\r\n                        break;\r\n                    }\r\n                case \"K\":   // CollectionRemoveKey\r\n                    {\r\n                        this._graph[e[1]].delete(this.getValue(e[2]));\r\n                        break;\r\n                    }\r\n                default: throw new Error(`Unexpected Event code: '${e[0]}'.`);\r\n            }\r\n        }\r\n        this._tranNum = event.N;\r\n    }\r\n\r\n    private getValue(o: any) {\r\n        if (o != null) {\r\n            var ref = o[\">\"];\r\n            if (ref !== undefined) return this._graph[ref];\r\n        }\r\n        return o;\r\n    }\r\n}\r\n\r\n\r\n\r\n","/**\r\n * Serializes an object in JSON that can contain internal relationships.\r\n * Serialized objects contain a \"<prefix>i\" field that is the index\r\n * in the breadth-first traversal of the graph done by JSON.stringify().\r\n * References to already serialized objects are exposed as single-property\r\n * objects like { \"<prefix>r\": idx }.\r\n * The deserialize function uses the index to restore the complete graph.\r\n * Parameter prefix is optional. It defaults to \"~$£€\".\r\n * @param {object} o - The object to serialize\r\n * @param {object} options - Serialization options: prefix (default '~$£€'), substitor\r\n * @return {string} The serialized value.\r\n */\r\nexport function serialize(o, options) {\r\n    const { prefix, substitor } = Object.assign({ prefix: \"~$£€\" }, options);\r\n    const rR = prefix + \">\";\r\n    const rI = prefix + \"°\";\r\n    const rT = prefix + \"þ\";\r\n    const marker = Symbol();\r\n    let cleanup = [];\r\n    try {\r\n        let c = 0;\r\n        function markObj(o) { o[marker] = 1; return o; }\r\n        function markNum(n) { return markObj(new Number(n)); }\r\n        function markTyp(s) {\r\n            if (typeof s !== \"string\") throw new Error(\"Type must be a String.\");\r\n            return markObj(new String(s));\r\n        }\r\n        return JSON.stringify(o, function (k, v) {\r\n            if (k === rR || k === rI || k === rT) {\r\n                if (v !== null && v[marker]) return v;\r\n                throw new Error(\"Conflicting serialization prefix: property '\" + k + \"' exists.\");\r\n            }\r\n            if (v === null || typeof v !== \"object\" || v[marker]) return v;\r\n            let ref = v[rI];\r\n            if (ref) {\r\n                if (ref[marker]) return { [rR]: ref };\r\n                throw new Error(\"Conflicting serialization prefix: property '\" + rI + \"' exists.\");\r\n            }\r\n            v[rI] = ref = markNum(c++);\r\n            cleanup.push(v);\r\n            if (v instanceof Array) {\r\n                v = markObj([markObj({ [rT]: markObj([ref, \"A\"]) }), ...v]);\r\n            }\r\n            else if (v instanceof Map) {\r\n                v = markObj([markObj({ [rT]: markObj([ref, \"M\"]) }), ...[...v].map(e => markObj(e))]);\r\n            }\r\n            else if (v instanceof Set) {\r\n                v = markObj([markObj({ [rT]: markObj([ref, \"S\"]) }), ...v]);\r\n            }\r\n            else if (substitor) {\r\n                let sv = substitor(v, rT);\r\n                if (sv && sv !== v) {\r\n                    v = sv;\r\n                    v[rI] = ref;\r\n                    v[rT] = markTyp(v[rT] || \"\");\r\n                }\r\n            }\r\n            return v;\r\n        });\r\n    }\r\n    finally {\r\n        cleanup.forEach(o => delete o[rI]);\r\n    }\r\n};\r\n\r\n/**\r\n * Deserializes a previously-serialized object graph.\r\n * Parameter prefix is optional and defaults to \"~$£€\": it must, of course,\r\n * be the same as the prefix used to serialize the graph.\r\n * @param {(string|object)} o - The serialized string, or parsed object.\r\n * @param {object} options - Serialization options: prefix (default '~$£€'), activator\r\n * @return {object} The deserialized value.\r\n */\r\nexport function deserialize(s /*:string|object*/, options) {\r\n    const { prefix, activator } = Object.assign({ prefix: \"~$£€\" }, options);\r\n    const rR = prefix + \">\";\r\n    const rI = prefix + \"°\";\r\n    const rT = prefix + \"þ\";\r\n    let extRef = null;\r\n    const map = [];\r\n\r\n    function rev(k, v) {\r\n        let type = null;\r\n        if (v instanceof Array) {\r\n            if (v.length > 0\r\n                && v[0] != null\r\n                && (type = v[0][rT]) !== undefined) {\r\n                v.splice(0, 1);\r\n                switch (type[1]) {\r\n                    case \"A\": break;\r\n                    case \"M\": v = Object.assign(new Map(), { \"v\": v }); break;\r\n                    case \"S\": v = Object.assign(new Set(), { \"v\": v }); break;\r\n                    default: throw new Error(\"Expecting typed array to be 'A', 'M' or 'S'.\");\r\n                }\r\n                map[type[0]] = v;\r\n            }\r\n        }\r\n        else if (v !== null) {\r\n            const idx = v[rI];\r\n            if (idx !== undefined) {\r\n                delete v[rI];\r\n                if ((type = v[rT]) !== undefined) {\r\n                    delete v[rT];\r\n                    if (activator) {\r\n                        v = activator(v, type);\r\n                        if (v) {\r\n                            if (extRef === null) extRef = new Set();\r\n                            extRef.add(v);\r\n                        }\r\n                    }\r\n                }\r\n                map[idx] = v;\r\n            }\r\n        }\r\n        return v;\r\n    }\r\n\r\n    // This simple depth-first traversal applies the reviver to an already \r\n    // JSON parsed tree.\r\n    function d(o) {\r\n        if (o) {\r\n            if (o instanceof Array) {\r\n                for (let i = 0; i < o.length; ++i) {\r\n                    const v = o[i];\r\n                    d(v);\r\n                    o[i] = rev(i, v);\r\n                }\r\n            }\r\n            else if (typeof (o) === \"object\") {\r\n                for (const p in o) {\r\n                    const v = o[p];\r\n                    d(v);\r\n                    o[p] = rev(p, v);\r\n                }\r\n            }\r\n        }\r\n        return o;\r\n    }\r\n    // If its a string, JSON.parse and the reviver handle the first step: registering the \r\n    // objects in map array and any external references into extRef set.   \r\n    const o = typeof (s) === \"string\"\r\n        ? JSON.parse(s, rev)\r\n        : rev(undefined, d(s));\r\n\r\n    // Second step is to handles the collections (array, map and set).\r\n    function processA(map, a) {\r\n        const len = a.length;\r\n        for (let i = 0; i < len; ++i) {\r\n            const c = a[i];\r\n            if (c) {\r\n                const ref = c[rR];\r\n                if (ref !== undefined) a[i] = map[ref];\r\n            }\r\n        }\r\n    }\r\n    for (let i of map) {\r\n        if (extRef === null || !extRef.has(i)) {\r\n            if (i instanceof Array) {\r\n                processA(map, i);\r\n            }\r\n            else if (i instanceof Map) {\r\n                i.v.forEach(e => processA(map, e));\r\n                i.v.forEach(e => i.set(e[0], e[1]));\r\n                delete i.v;\r\n            }\r\n            else if (i instanceof Set) {\r\n                processA(map, i.v);\r\n                i.v.forEach(e => i.add(e));\r\n                delete i.v;\r\n            }\r\n            else {\r\n                for (const p in i) {\r\n                    const o = i[p];\r\n                    if (o !== null) {\r\n                        const ref = o[rR];\r\n                        if (ref !== undefined) i[p] = map[ref];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return o;\r\n}"],"sourceRoot":""}